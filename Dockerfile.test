# üê≥ TranslateCore Test Docker Container
# –ë—ã—Å—Ç—Ä–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞–∫–µ—Ç–æ–≤

FROM python:3.11-slim

# –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
LABEL maintainer="TranslateCore Team"
LABEL description="TranslateCore test container"
LABEL version="1.0.0-test"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
RUN useradd -m -u 1000 translator && \
    mkdir -p /app && \
    chown -R translator:translator /app

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
WORKDIR /app

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ requirements
COPY requirements.txt* ./
RUN if [ -f requirements.txt ]; then pip install --no-cache-dir -r requirements.txt; fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π TranslateCore
RUN pip install --no-cache-dir \
    deep-translator==1.11.4 \
    requests>=2.28.0 \
    argostranslate>=1.8.0 \
    colorama>=0.4.6

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞
COPY --chown=translator:translator . .

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
RUN mkdir -p /app/data /app/cache /app/logs && \
    chown -R translator:translator /app/data /app/cache /app/logs

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
RUN chmod +x translate-cli.py docker-translate-cli.py scripts/*.sh examples/*.py || true

# –°–æ–∑–¥–∞–Ω–∏–µ alias –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ Docker
RUN echo '#!/bin/bash' > /app/translatecore && \
    echo 'python3 /app/docker-translate-cli.py "$@"' >> /app/translatecore && \
    chmod +x /app/translatecore

# –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è translator
USER translator

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
ENV PYTHONPATH=/app/src:/app
ENV TRANSLATE_DATA_DIR=/app/data
ENV TRANSLATE_CACHE_DIR=/app/cache
ENV TRANSLATE_LOG_DIR=/app/logs
ENV PATH=/app:$PATH

# Volumes –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
VOLUME ["/app/data", "/app/cache", "/app/logs"]

# –°–æ–∑–¥–∞–Ω–∏–µ –∞–ª–∏–∞—Å–∞ –≤ bashrc
RUN echo 'alias translate-cli="python3 /app/docker-translate-cli.py"' >> ~/.bashrc

# –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
ENTRYPOINT ["/bin/bash", "-c"]
CMD ["echo 'üåç TranslateCore Docker Container Ready!' && echo '' && echo 'Available commands:' && echo '  translatecore --help                    # CLI help' && echo '  translatecore \"Hello World\"              # Quick translation' && echo '  translatecore -i                        # Interactive mode' && echo '  python3 /app/examples/basic_usage.py   # Examples' && echo '' && echo 'Direct Python API:' && echo '  python3 -c \"import sys; sys.path.insert(0,\\\"/app/src\\\"); from translatecore import OfflineTranslator; print(\\\"‚úÖ API ready!\\\")\"' && echo '' && exec /bin/bash"]

# –ü—Ä–æ—Å—Ç–æ–π healthcheck
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python3 -c "print('‚úÖ Container healthy')" || exit 1
